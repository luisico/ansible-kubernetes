---
- name: Create short-lived join token
  command: >
    kubeadm token create --ttl 1h --description 'Ansible kubernetes bootstrap'
  register: kubernetes__r_token

- name: Get discovery ca cert hash
  shell: >
    openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
  register: kubernetes__r_hash
  changed_when: no

- name: Save discovery token and hash
  set_fact:
    kubernetes_discovery_token: '{{ kubernetes__r_token.stdout }}'
    kubernetes_discovery_hash: '{{ kubernetes__r_hash.stdout }}'
